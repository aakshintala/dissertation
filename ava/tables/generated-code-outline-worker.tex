% -*- fill-column: 85; -*-
%!TEX root = main.tex

\begin{figure}
\begin{lstlisting}[language=C,columns=flexible,belowskip=-0.5em,aboveskip=-0.5em,mathescape,basicstyle={\scriptsize\ttfamily}]
void api_server_handle_command(call) {
  switch (call->command_id) {
  case CALL_CU_STREAM_SYNCHRONIZE: {
    // For handles, get the real address
    CUstream stream = handle_deref(call->stream);
    // Get pointers to shadows of the attached buffers
    void **bufs = get_buffer(call, call->bufs);
    size_t nbufs = get_n_bufs(async_DtoH, stream);
    for (size_t i = 0; i < nbufs; i++)
      bufs[i] = get_shadow_buffer(call, bufs[i]);
    // Perform call
    CUresult stat = cuStreamSynchronize(stream);
    // Construct and send the return command
    cu_stream_synchronize_ret *ret_cmd = $\txt{alloc()}$;
    ret_cmd->command_id = RET_CU_STREAM_SYNCHRONIZE;
    ret_cmd->call_id = call->call_id; ret_cmd->ret = stat;
    // Attach sync buffers to return command
    void **tmp_bufs = $\txt{alloc()}$;$\label{line:sync-bufs-start}$
    for (size_t i = 0; i < nbufs; i++)
      tmp_bufs[i] = attach_buffer(ret_cmd, bufs[i],
         get_buf_size(async_DtoH, stream, i));
    ret_cmd->bufs = attach_buffer(ret_cmd, tmp_bufs, 
       nbufs *$$ sizeof(void *));$\label{line:sync-bufs-end}$
    send_command(ret_cmd);
    break; }
  case CALL_CU_MEMCPY_DTOH_ASYNC: {
    |\elidedcode{Extract dst, stream, and size from call}||\label{line:extract-start}|
    // Get or allocate the shadow buffer
    void *dst = get_shadow_buffer(call, call->dst);|\label{line:extract-end}|
    // Execute state-tracking code from spec
    register_buf(async_DtoH, stream, dst, size);|\label{line:register-buf}|
    // Perform call
    CUresult stat = cuMemcpyDtoHAsync(dst, src, size, stream);
    |\elidedcode{Construct and send the return command}|
    break; } ... } }
\end{lstlisting}
\caption{An outline of the generated \worker code for \spec|cuStreamSynchronize| and \spec|cuMemcpyDtoHAsync|.
}
\label{fig:generated-code-outline-worker}
\vspace*{-.5em}
\end{figure}
