\documentclass[sigplan,screen]{acmart}
%\settopmatter{authorsperrow=4}

%replace XXX with the submission number you are given from the ASPLOS submission site.
\newcommand{\asplossubmissionnumber}{324}

\hypersetup{
	colorlinks=true,
}

% AA: I need this so that the 'fi' ligature in the pdfs compiles correctly on my machine.
\pdfmapline{-dummy LMRoman10-Regular}

% Uncomment to show margins
% \usepackage{showframe}

\usepackage{balance}
\setlength{\paperheight}{11in}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{ifthen}
\usepackage{color}
\usepackage[normalem]{ulem}
\usepackage{hhline}
\usepackage{xcolor,colortbl}
\usepackage{alltt}
\usepackage{amssymb}
\usepackage{enumitem}
\usepackage{breakcites}
\usepackage{microtype}
\usepackage{flushend} 	% It balance references in the last page, but it has a bug
% to display a last reference.
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{rotating}
\usepackage{float}
\usepackage{siunitx}
\usepackage{dcolumn}
% \usepackage{textcomp}

\usepackage{array}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{tabulary}
\usepackage{makecell}

\usepackage{wrapfig}
\usepackage{comment}
% \usepackage[hyphens]{url} % break lines at hyphens
\usepackage{adjustbox}
\usepackage{ragged2e}
\usepackage{pifont}
\usepackage{amsmath}
\usepackage{changepage}
%\usepackage[kerning=true,spacing=true]{microtype}
%\usepackage{microtype}
\usepackage[font=small,labelfont=bf]{caption}
\usepackage{placeins}
%\usepackage[sort]{natbib} % sort option relplaces cite package
%\usepackage[sort&compress]{natbib}
% Don't use titling with acmart.cls
% \usepackage{titling}
\usepackage{setspace}

% \usepackage[
% colorlinks,linkcolor={black},citecolor={black},
% urlcolor={black}
% ]
% {hyperref}

\usepackage{float}
\usepackage{tikz}
\usepackage{pgfplots}
\def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;}
\newcommand{\cross}{$\mathbin{\tikz [x=1.4ex,y=1.4ex,line width=.2ex] \draw (0,0) -- (1,1) (0,1) -- (1,0);}$}%

\usepackage[T1]{fontenc}

\renewcommand{\ttdefault}{txtt}
% YAML highlight
%\usepackage[dvipsnames]{xcolor}
\usepackage{listings}
\lstset{
	literate={\_}{}{0\discretionary{\_}{}{\_}}%
}

\newcommand*{\origrightarrow}{}
\let\oldarrow\textrightarrow
\renewcommand*{\textrightarrow}{\fontfamily{cmr}\selectfont\origrightarrow}
%\setlength{\belowcaptionskip}{-10pt} % -10pt is the best

%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% SPACE SQUEEZE STUFF
%%% TRY NOT TO USE!
%%%%%%%%%%%%%%%%%%%%%%%%%%
\newboolean{squeeze}
\setboolean{squeeze}{true}
%\setboolean{squeeze}{false}
\ifthenelse{\boolean{squeeze}}{
  %\renewcommand{\baselinestretch}{0.99} % VM: Taking this out for now to improve readability
  \setlength{\textfloatsep}{1ex plus 1ex minus .2ex}
  \setlength{\intextsep}{1ex plus 1ex minus .2ex}
  \setlength{\floatsep}{1ex plus 1ex minus .2ex}
  \captionsetup[table]{belowskip=0pt,aboveskip=0pt}
  \captionsetup[figure]{belowskip=0pt,aboveskip=5pt}

  \widowpenalty=25
  \clubpenalty=25
}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% SQUEEZE \section
%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\let\orig@section\section
\newcommand{\@sectionstar}[1]{\vspace{-0.5\baselineskip}\orig@section*{#1}\vspace{-0.2pt}}
\newcommand{\@sectionnostar}[1]{\vspace{-0.5\baselineskip}\orig@section{#1}\vspace{-0.2pt}}
\renewcommand{\section}{\@ifstar{\@sectionstar}{\@sectionnostar}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% SQUEEZE \subsection
%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\let\orig@subsection\subsection
\renewcommand{\subsection}[1]{\vspace{-0.5\baselineskip}\orig@subsection{#1}\vspace{-0.35pt}}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% SQUEEZE bib
%%%%%%%%%%%%%%%%%%%%%%%%%%
\let\oldbibliography\thebibliography
\renewcommand{\thebibliography}[1]{\oldbibliography{#1}
	\setlength{\itemsep}{0pt}}

\newcommand\T{\rule{0pt}{2.0ex}}
\newcommand\B{\rule[-0.9ex]{0pt}{0pt}}
\newcommand{\fs}[1]{\footnotesize{#1}}
\newcommand{\bfs}[1]{\textbf{\footnotesize{#1}}}
% \newcommand{\mrot}[1]{\begin{rotate}{55}{\bfs{#1}}\end{rotate}}
% \newcommand{\rot}[1]{\begin{rotate}{90}{\bfs{#1}}\end{rotate}}

%% ---------------------------------------
%% change this to hide/show the grumblers
%% and ``for our eyes only'' sections
%% ---------------------------------------

\newboolean{publicversion}
%\setboolean{publicversion}{false}
\setboolean{publicversion}{true}

\newboolean{changecoloring}
%\setboolean{changecoloring}{false}
\setboolean{changecoloring}{true}

\newboolean{tinypolishing}
\setboolean{tinypolishing}{false}

\colorlet{changecoloringtmp}{black}
\ifthenelse{\boolean{changecoloring}}{
  \DeclareCaptionFont{unchangedcaptionfont}{\color{gray}}
  \DeclareCaptionFont{changedcaptionfont}{\color{black}}

  \newcommand*{\beginunchanged}{%
  \colorlet{changecoloringtmp}{.}%
  \color{gray}%
  \captionsetup{labelfont={unchangedcaptionfont,bf},textfont=unchangedcaptionfont}%
  \let\changecoloringtmpgrumbler\grumbler
  \def\grumbler{}}

  \newcommand*{\beginchanged}{%
  \color{changecoloringtmp}%
  \captionsetup{labelfont={changedcaptionfont,bf},textfont=changedcaptionfont}%
  \let\grumbler\changecoloringtmpgrumbler}
}{
  \newcommand*{\beginunchanged}{}
  \newcommand*{\beginchanged}{}
}

\ifthenelse{\boolean{publicversion}}{
  \newcommand{\polishing}[1]{}
}{
\ifthenelse{\boolean{tinypolishing}}{
  \newcommand{\polishing}[1]{\bgroup#1\egroup}
}{
  \newcommand{\polishing}[1]{\bgroup\def\bf{} Polishing: #1\egroup}
}
}

\ifthenelse{\boolean{publicversion}}{
	\newcommand{\grumbler}[3]{}
}{
	\newcommand{\grumbler}[3]{\textcolor{#3}{\bf #1: #2}}
}

% Add your own...
\newcommand{\cjr}[1]{\grumbler{CJR}{#1}{blue}}
\newcommand{\hyu}[1]{\grumbler{HYU}{#1}{YellowOrange}}
\newcommand{\aak}[1]{\grumbler{AA}{#1}{violet}}
\newcommand{\amp}[1]{\grumbler{AMP}{#1}{purple}}
\newcommand{\review}[1]{\grumbler{Reviewer}{#1}{red}}
\newcommand{\reviewer}[2]{\grumbler{Reviewer\##1}{#2}{red}}

\newcommand{\newterm}[1]{{\bf #1}}
\newcommand{\parname}[1]{\textbf{\textit{#1}}}
\newcommand{\paragraphbe}[1]{\vspace{.25ex}\noindent\parname{#1} }

% This macro that I got off stackexchange is supposed to help LaTeX understand how to break
% URLs nicely across lines.
% https://tex.stackexchange.com/a/10401
\expandafter\def\expandafter\UrlBreaks\expandafter{\UrlBreaks
  \do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j
  \do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t
  \do\u\do\v\do\w\do\x\do\y\do\z\do\A\do\B\do\C\do\D
  \do\E\do\F\do\G\do\H\do\I\do\J\do\K\do\L\do\M\do\N
  \do\O\do\P\do\Q\do\R\do\S\do\T\do\U\do\V\do\W\do\X
  \do\Y\do\Z}

\input{terminology}

% YAML highlight
\newcommand\YAMLcolonstyle{\color{red}\mdseries}
\newcommand\YAMLkeystyle{\color{black}\bfseries}
\newcommand\YAMLvaluestyle{\color{blue}\mdseries}

\makeatletter
% here is a macro expanding to the name of the language
% (handy if you decide to change it further down the road)
\newcommand\language@yaml{yaml}
\expandafter\expandafter\expandafter\lstdefinelanguage
\expandafter{\language@yaml}
{
	keywords={true,false,null,y,n},
	keywordstyle=\color{darkgray}\bfseries,
	basicstyle=\YAMLkeystyle,                                 % assuming a key comes first
	sensitive=false,
	comment=[l]{\#},
	morecomment=[s]{/*}{*/},
	commentstyle=\color{purple}\ttfamily,
	stringstyle=\YAMLvaluestyle\ttfamily,
	moredelim=[l][\color{orange}]{\&},
	moredelim=[l][\color{magenta}]{*},
	moredelim=**[il][\YAMLcolonstyle{:}\YAMLvaluestyle]{:},   % switch to value style at :
	morestring=[b]',
	morestring=[b]",
	literate =    {---}{{\ProcessThreeDashes}}3
	{>}{{\textcolor{red}\textgreater}}1
	{|}{{\textcolor{red}\textbar}}1
	{\ -\ }{{\mdseries\ -\ }}3,
}

% switch to key style at EOL
\lst@AddToHook{EveryLine}{\ifx\lst@language\language@yaml\YAMLkeystyle\fi}

\newcommand{\elidedcodeStart}[1]{\bgroup\itshape\color{black!60!green}[\aftergroup\elidedcodeEnd}
\def\elidedcodeEnd{]\egroup}
\newcommand{\elidedcode}[1]{\text{\itshape\color{black!60!green}...{#1}...}}
    
\makeatother

\lstset{
	breaklines=true,
	basicstyle={\small\ttfamily},
	literate={*}{{\fontfamily{lmtt}\selectfont*}}1,
	numbers=left,
	numberstyle=\scriptsize\color{gray!50!black},
	commentstyle=\itshape\color{black!60!green},
	%stepnumber=1,
	numbersep=4pt,
    moredelim={**[is][\lapisprototypestyle]{@@}{@@}},
    escapechar=|
}

% http://tex.stackexchange.com/q/43526
% fix the apparently deliberate but undocumented behaviour of disabling escapes other than mathescape in TextStyle (used by \lstinline)
% there may be a good reason why this is disabled by default, so beware in case it causes any problems
\usepackage{etoolbox}
\makeatletter
\patchcmd{\lsthk@TextStyle}{\let\lst@DefEsc\@empty}{}{}{\errmessage{failed to patch}}
\makeatother

% The box macro in case we need it

%\usepackage{tikz}
%\makeatletter
%\newcommand{\bt@HL@box}[2][]{%
%    \tikz[#1]{%
%        \pgfpathrectangle{\pgfpoint{1pt}{0pt}}{\pgfpoint{\wd #2}{\ht #2}}%
%        \pgfusepath{use as bounding box}%
%        \node[anchor=base west, outer sep=0pt,inner xsep=1pt, inner ysep=0pt, rounded corners=1pt, minimum height=\ht\strutbox+1pt,#1]{\raisebox{1pt}{\strut}\strut\usebox{#2}};
%    }%
%}
%\newenvironment{btHighlight}[1][]
%{\begingroup\tikzset{bt@Highlight@par/.style={#1}}\begin{lrbox}{\@tempboxa}}
%    {\end{lrbox}\bt@HL@box[bt@Highlight@par]{\@tempboxa}\endgroup}
%
%\newcommand\btHL[1][]{%
%    \begin{btHighlight}[#1]\bgroup\aftergroup\bt@HL@endenv%
%}
%\def\bt@HL@endenv{%
%    \end{btHighlight}%
%    \egroup
%}
%\makeatother

% Due to how lstlisting works, this works better if it SETs the style instead of styling and argument.
\newcommand*{\lapiskeywordstyle}{\color{blue!50!black}\bfseries}
\newcommand*{\lapisstdlibstyle}{\color{green!40!black}\itshape}
\newcommand*{\lapisprototypestyle}{\color{black!70}}


\lstdefinestyle{nwspecc}{
	breaklines=true,
	language=C,
    % This intentionally replaces all normal C keywords, since they are not the important part of nwspecc listings.
    keywords={},
    % API remoting related Lapis keywords
    emph={[1]sync,async,name,version,identifier,opaque,
          number,export_qualifier,success,type,in,out,buffer,
          zerocopy,type_cast,
          element,allocates,deallocates,argument,
          handle,callback,userdata,return_value,field,
          contextual_argument,
          lifetime_manual,lifetime_call,allocate,deallocate,no_copy,
          index,policy,
          utility},
          % \btHL[fill=blue!10,draw=blue!50!black]
    emphstyle={[1]\lapiskeywordstyle},
    % Resource accounting related Lapis keywords
    emph={[2]throughput_rc,consumes_rc,allocates_rc,deallocates_rc,
              continuous_rc,instantaneous_rc},
    emphstyle={[2]\lapiskeywordstyle},
    % Record-and-replay related Lapis keywords
    emph={[3]obj_record,obj_depends_on,obj_state_cbs},
    emphstyle={[3]\lapiskeywordstyle},
    % Standard library
    emph={[4]buf_registry,register_buf,get_bufs,get_n_bufs,get_buf_size,
        declare_metadata,metadata,
        strlen,min,max,
        zerocopy_alloc,zerocopy_free,zerocopy_get_physical_address},
    emphstyle={[4]\lapisstdlibstyle},
    moredelim={**[is][\lapisprototypestyle]{@@}{@@}}
}

%
% Table
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{M}[1]{>{\centering\arraybackslash}m{#1}}

\newcommand\ProcessThreeDashes{\llap{\color{cyan}\mdseries-{-}-}}
%\setlength{\bibsep}{2.5pt}

%
% defining the \BibTeX command - from Oren Patashnik's original BibTeX documentation.
\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08emT\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}

%%
%% \BibTeX command to typeset BibTeX logo in the docs
\AtBeginDocument{%
	\providecommand\BibTeX{{%
			\normalfont B\kern-0.5em{\scshape i\kern-0.25em b}\kern-0.8em\TeX}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
\copyrightyear{2020}
\acmYear{2020}
\setcopyright{acmcopyright}
\acmConference[ASPLOS '20]{Proceedings of the Twenty-Fifth International Conference on Architectural Support for Programming Languages and Operating Systems}{March 16--20, 2020}{Lausanne, Switzerland}
\acmBooktitle{Proceedings of the Twenty-Fifth International Conference on Architectural Support for Programming Languages and Operating Systems (ASPLOS '20), March 16--20, 2020, Lausanne, Switzerland}
\acmPrice{15.00}
\acmDOI{10.1145/3373376.3378466}
\acmISBN{978-1-4503-7102-5/20/03}

\fancyhead{}

%
% end of the preamble, start of the body of the document source.
\begin{document}

\input{sections/abstract}

%\title{Accelerator Virtualization with \model}
%\title{Hypervisor-level Accelerator Virtualization via Language and Compiler Support}
%\title{Language and Compiler-Assisted Hypervisor-level Accelerator Virtualization}
%\title{Automatic Virtualization of Accelerators with \model}
\title{\model: Accelerated Virtualization of Accelerators}

\begin{comment}
\author{Hangchen Yu}
\affiliation{%
	\institution{The University of Texas at Austin}
}
\email{hyu@cs.utexas.edu}

\author{Arthur M. Peters}
\affiliation{%
	\institution{The University of Texas at Austin}
}
\email{amp@cs.utexas.edu}

\author{Amogh Akshintala}
\affiliation{%
	\institution{The University of North Carolina at Chapel Hill}
}
\email{aakshintala@cs.unc.edu}

\author{Christopher J. Rossbach}
\affiliation{%
	\institution{The University of Texas at Austin and VMware Research}
}
\email{rossbach@cs.utexas.edu}
\end{comment}

\author{Hangchen Yu$^{\dagger}$, Arthur Michener Peters$^{\dagger}$, Amogh Akshintala$^{\mathsection}$, Christopher J. Rossbach$^{\dagger\mathparagraph}$}
\affiliation{
	\institution{$^{\dagger}$The University of Texas at Austin, $^{\mathsection}$The University of North Carolina at Chapel Hill, $^{\mathparagraph}$VMware Research}
}
\email{{hyu,amp}@cs.utexas.edu,  aakshintala@cs.unc.edu,  rossbach@cs.utexas.edu}

\begin{CCSXML}
	<ccs2012>
	<concept>
	<concept_id>10011007.10010940.10010941.10010942.10010948</concept_id>
	<concept_desc>Software and its engineering~Virtual machines</concept_desc>
	<concept_significance>500</concept_significance>
	</concept>
	<concept>
	<concept_id>10011007.10010940.10010941.10010949</concept_id>
	<concept_desc>Software and its engineering~Operating systems</concept_desc>
	<concept_significance>300</concept_significance>
	</concept>
	<concept>
	<concept_id>10011007.10011006.10011041.10011047</concept_id>
	<concept_desc>Software and its engineering~Source code generation</concept_desc>
	<concept_significance>300</concept_significance>
	</concept>
	</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~Virtual machines}
\ccsdesc[300]{Software and its engineering~Operating systems}
\ccsdesc[300]{Software and its engineering~Source code generation}

\keywords{Virtualization, Code generation}

%\date{}
\renewcommand{\shortauthors}{H. Yu, A. M. Peters, A. Akshintala and C. J. Rossbach}
\maketitle

\thispagestyle{empty}
%\setdefaultleftmargin{0em}{2em}{}{}{}{}

%\beginunchanged

\input{sections/intro}
\input{sections/background}
%\input{sections/motivation}
\input{sections/design}
\input{sections/core}
%\beginchanged
\input{sections/api}
\input{sections/migration}
\input{sections/limitations}
%\beginunchanged
\input{sections/impl}
\input{sections/eval}
\input{sections/related}
\input{sections/conclusion}
\input{sections/acks}
% \ifthenelse{\boolean{publicversion}}{}{
   % \input{sections/playground}
% }

\label{last_page}
\clearpage

%
% The next two lines define the bibliography style to be used, and the bibliography file.
\input{confnames}
\interlinepenalty=10000
\bibliographystyle{ACM-Reference-Format}
\bibliography{bib/extracted}{}
% \bibliography{bib/bibliography,bib/vgpu}{}

%\beginchanged
\newpage
\appendix
\input{artifact_eval_appendix}
%\input{sections/generated-code}

\end{document}
